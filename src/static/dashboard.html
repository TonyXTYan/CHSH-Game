<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PHB6HZJJ7X"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PHB6HZJJ7X');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHSH Game - Presenter Dashboard</title>
    <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
    <h1>CHSH Game - Presenter Dashboard</h1>
    <div id="connection-status-dash">Connecting...</div>

    <div class="dashboard-container">
        <div class="panel metrics">
            <div class="metric-card">
                <h3>Active Teams</h3>
                <p id="active-teams-count">0</p>
            </div>
            <div class="metric-card">
                <h3>Players</h3>
                <div class="players-grid">
                    <div>Connected:</div>
                    <div id="connected-players-count">0</div>
                    <div>Paired:</div>
                    <div id="ready-players-count">0</div>
                </div>
            </div>
            <div class="metric-card">
                <h3>Total Responses</h3>
                <p id="total-responses-count">0</p>
            </div>
            <div class="metric-card download-card">
                <h3>Download Data</h3>
                <button id="download-data-btn" onclick="downloadData()">Download CSV</button>
            </div>
            <div class="metric-card">
                <h3 id="game-control-text">Game Control</h3>
                <div class="game-controls">
                    <button id="start-game-btn" onclick="startGame()">Start Game</button>
                    <button id="pause-game-btn" onclick="togglePause()" style="display: none;">Pause</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2>Teams</h2>
                <div class="team-filters">
                    <label>
                        <input type="checkbox" id="show-inactive">
                        Show Inactive Teams
                    </label>
                    <select id="sort-teams">
                        <option value="status">Sort by Status</option>
                        <option value="name">Sort by Name</option>
                        <option value="date">Sort by Last Active</option>
                    </select>
                </div>
            </div>
            <table id="active-teams-table">
                <thead><tr>
                    <th>Team Name</th>
                    <th>Status</th>
                    <th>Current Round</th>
                    <th>Stats Sig</th>
                    <th>Trace Avg ⏐⟨Tr⟩⏐</th>
                    <th>Balance</th>
                    <th>Balanced ⏐⟨Tr⟩⏐</th>
                    <th>CHSH Value</th>
                    <th>Details</th>
                </tr></thead>
                <tbody></tbody>
            </table>
            <p id="no-active-teams">No active teams yet.</p>
        </div>
        
        <!-- Modal/popup for team details -->
        <div id="team-details-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h3><span>Team: </span><span id="modal-team-name"></span></h3>
                <div class="modal-section">
                    <h4>Team Details</h4>
                    <div class="details-container">
                        <div>
                            <strong>Team ID:</strong>
                            <span id="modal-team-id" style="font-family: monospace;"></span>
                        </div>
                        <div>
                            <strong>Player 1 SID:</strong>
                            <span id="modal-player1-sid" style="font-family: monospace;"></span>
                        </div>
                        <div>
                            <strong>Player 2 SID:</strong>
                            <span id="modal-player2-sid" style="font-family: monospace;"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>History Hashes</h4>
                    <div class="hash-container">
                        <div>
                            <strong>SHA-256:</strong>
                            <span id="modal-hash1"></span>
                        </div>
                        <div>
                            <strong>MD5:</strong>
                            <span id="modal-hash2"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Correlation Matrix</h4>
                    <table id="correlation-matrix-table"></table>
                </div>
                <div class="modal-section">
                    <h4>CHSH Statistics</h4>
                    <div class="details-container">
                        <div><strong>Actual CHSH Value:</strong> <span id="modal-chsh-value" style="font-family: monospace;"></span></div>
                        <div><strong>Cross-Term CHSH:</strong> <span id="modal-cross-term-chsh" style="font-family: monospace;"></span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;" onclick="toggleAnswerStream()">
                <h2 style="margin: 0;">Live Answer Log</h2>
                <span id="toggle-chevron" style="font-weight: bold; margin-left: 5px; font-size: 1.1em;">▶</span>
                <span style="margin-right: 3px;">streaming</span>
                <button id="toggle-answers-btn" onclick="event.stopPropagation(); toggleAnswerStream()" class="toggle-off" style="padding: 4px 8px; font-size: 0.9em;">OFF</button>
            </div>
            <table id="answer-log-table">
                <thead><tr><th>Timestamp</th><th>Team Name</th><th>Player SID</th><th>Round ID</th><th>Item</th><th>Answer</th></tr></thead>
                <tbody></tbody>
            </table>
            <p id="no-answers-log">No answers streamed yet.</p>
        </div>
    </div>

    <footer style="text-align: center; margin-top: 10px; padding: 10px; color: #666;">
        <a href="https://github.com/TonyXTYan/CHSH-Game" target="_blank" style="color: #666; text-decoration: none;">
            Source code on GitHub: github.com/TonyXTYan/CHSH-Game
        </a>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script src="/static/dashboard.js"></script>
</body>
</html>
