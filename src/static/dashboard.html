<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PHB6HZJJ7X"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PHB6HZJJ7X');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHSH Game - Host Dashboard</title>
    <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
    <div class="header-parent-container">
        <div class="metric-card qr-code-container">
            <h3>Join the game</h3>
            <p><a href="https://chsh-game.fly.dev" target="_blank">chsh-game.fly.dev</a></p>
            <div style="display: flex; justify-content: center; align-items: center;">
                <img src="https://genqrcode.com/embedded?style=0&inner_eye_style=0&outer_eye_style=0&logo=null&color=%23000000FF&background_color=%23E7F3FF&imageformat=svg&language=en&frame_style=0&frame_text=SCAN%20ME&frame_color=%23000000&invert_colors=false&gradient_style=0&gradient_color_start=%23FF0000&gradient_color_end=%237F007F&gradient_start_offset=5&gradient_end_offset=95&stl_type=1&logo_remove_background=null&stl_size=100&stl_qr_height=1.5&stl_base_height=2&stl_include_stands=false&stl_qr_magnet_type=3&stl_qr_magnet_count=0&type=0&text=https%3A%2F%2Fchsh-game.fly.dev&width=300&height=300&bordersize=2" alt="QR Code"/>
            </div>
        </div>
        <div class="right-content-container">
            <h1>CHSH Game - Host Dashboard</h1>
            <div id="connection-status-dash">Connecting...</div>
            <div class="panel metrics">
                <div class="metric-card comprehensive-stats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Active Teams</div>
                            <div class="stat-value" id="active-teams-count">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Connected Players</div>
                            <div class="stat-value" id="connected-players-count">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Paired Players</div>
                            <div class="stat-value" id="ready-players-count">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Total Responses</div>
                            <div class="stat-value" id="total-responses-count">0</div>
                        </div>
                    </div>
                </div>
                <div class="metric-card">
                    <h3 id="game-control-text">Game Control</h3>
                    <div class="game-controls">
                        <button id="start-game-btn" onclick="startGame()" style="border: 2px solid #4CAF50;">Start Game</button>
                        <button id="pause-game-btn" onclick="togglePause()" style="border: 2px solid #FFC107;">Pause</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="panel">
            <div class="panel-header">
                <div id="teams-header" onclick="toggleTeamsStream()">
                    <h2>Teams</h2>
                    <span id="teams-toggle-chevron">‚ñ∂</span>
                    <span class="streaming-text">streaming</span>
                    <button id="toggle-teams-btn" onclick="event.stopPropagation(); toggleTeamsStream()" class="toggle-off">OFF</button>
                </div>
                <div class="team-filters">
                    <label>
                        <img class="refresh-icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Refresh_icon.png/250px-Refresh_icon.png" alt="refresh">
                        
                        <input type="checkbox" id="show-inactive">
                        Show Inactive Teams
                    </label>
                    <select id="sort-teams">
                        <option value="status">Sort by Status</option>
                        <option value="name">Sort by Name</option>
                        <option value="date">Sort by Last Active</option>
                    </select>
                </div>
            </div>
            <table id="active-teams-table">
                <thead><tr>
                    <th>Team Name</th>
                    <th>Status</th>
                    <th>Current Round</th>
                    <th>Stats Sig</th>
                    <th>Trace Avg ‚èê‚ü®Tr‚ü©‚èê</th>
                    <th>Balance</th>
                    <th>Balanced ‚èê‚ü®Tr‚ü©‚èê üéØ</th>
                    <th>CHSH Value üèÜ</th>
                    <th>Details</th>
                </tr></thead>
                <tbody></tbody>
            </table>
            <p id="no-active-teams">No active teams yet.</p>
        </div>
        
        <!-- Modal/popup for team details -->
        <div id="team-details-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h3><span>Team: </span><span id="modal-team-name"></span></h3>
                <div class="modal-section">
                    <h4>Team Details</h4>
                    <div class="details-container">
                        <div>
                            <strong>Team ID:</strong>
                            <span id="modal-team-id"></span>
                        </div>
                        <div>
                            <strong>Player 1 SID:</strong>
                            <span id="modal-player1-sid"></span>
                        </div>
                        <div>
                            <strong>Player 2 SID:</strong>
                            <span id="modal-player2-sid"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>History Hashes</h4>
                    <div class="hash-container">
                        <div>
                            <strong>SHA-256:</strong>
                            <span id="modal-hash1"></span>
                        </div>
                        <div>
                            <strong>MD5:</strong>
                            <span id="modal-hash2"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Correlation Matrix</h4>
                    <table id="correlation-matrix-table"></table>
                </div>
                <div class="modal-section">
                    <h4>CHSH Statistics</h4>
                    <div class="details-container">
                        <div><strong>Actual CHSH Value:</strong> <span id="modal-chsh-value"></span></div>
                        <div><strong>Cross-Term CHSH:</strong> <span id="modal-cross-term-chsh"></span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div id="live-answer-log-header" onclick="toggleAnswerStream()">
                <h2 >Live Answer Log</h2>
                <span id="toggle-chevron">‚ñ∂</span>
                <span class="streaming-text">streaming</span>
                <button id="toggle-answers-btn" onclick="event.stopPropagation(); toggleAnswerStream()" class="toggle-off">OFF</button>
            </div>
            <table id="answer-log-table">
                <thead><tr><th>Timestamp</th><th>Team Name</th><th>Player SID</th><th>Round ID</th><th>Item</th><th>Answer</th></tr></thead>
                <tbody></tbody>
            </table>
            <p id="no-answers-log">No answers streamed yet.</p>
        </div>

        <!-- Advanced Controls Section -->
        <div class="panel">
            <div class="panel-header">
                <div id="advanced-controls-header" onclick="toggleAdvancedControls()">
                    <h2>Advanced Controls</h2>
                    <span id="advanced-controls-chevron">‚ñ∂</span>
                </div>
            </div>
            <div id="advanced-controls-content" class="advanced-controls-content" style="display: none;">
                <!-- Game Mode Control -->
                <div class="control-section">
                    <h4>Game Mode</h4>
                    <div class="game-mode-controls">
                        <div class="current-mode-display">
                            <span>Current Mode: </span>
                            <span id="current-game-mode" class="mode-indicator">New</span>
                        </div>
                        <button id="toggle-mode-btn" onclick="toggleGameMode()" class="control-btn mode-toggle-btn">
                            Switch to Classic Mode
                        </button>
                        <div class="mode-description">
                            <div id="mode-description-text">
                                <strong>New Mode:</strong> Player 1 receives only A/B questions, Player 2 receives only X/Y questions. 
                                Metrics focus on success rates and optimal strategy adherence.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Export Control -->
                <div class="control-section">
                    <h4>Data Export</h4>
                    <div class="export-controls">
                        <div class="export-description">
                            Download all game data as CSV files for analysis.
                        </div>
                        <div class="export-buttons">
                            <button onclick="downloadData()" class="control-btn export-btn">
                                üìä Download CSV (JavaScript)
                            </button>
                            <button onclick="window.open('/download', '_blank')" class="control-btn export-btn">
                                üìà Download CSV (Python)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-link">
                <a href="/" target="_blank">Go to Game (player's page)</a>
            </div>
            
            <div class="footer-link">
                <a href="https://github.com/TonyXTYan/CHSH-Game" target="_blank">
                    Source code on GitHub: github.com/TonyXTYan/CHSH-Game
                </a>
            </div>

            <div> 
                <span class="footer-text"><strong>Made with LLMs by Tony Yan 2025 </strong></span>
            </div>
            
            <div class="session-info" id="sessionInfo">
                Server ID: <span class="session-id"></span>
            </div>
        </div>
    </footer>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="/static/dashboard.js"></script>
</body>
</html>
