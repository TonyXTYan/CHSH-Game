<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Quiz - Participant</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #333; }
        .hidden { display: none; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background-color: #007bff; color: white; font-size: 16px; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.65; }
        input[type="text"] { padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 4px; width: calc(100% - 22px); }
        ul { list-style-type: none; padding: 0; }
        li { background: #eee; padding: 10px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .status-message { margin-top: 15px; padding: 10px; border-radius: 4px; text-align: center; }
        .status-info { background-color: #e7f3fe; border-left: 6px solid #2196F3; }
        .status-error { background-color: #ffebee; border-left: 6px solid #f44336; }
        .status-success { background-color: #e8f5e9; border-left: 6px solid #4CAF50; }
        .status-warning { background-color: #fff9e6; border-left: 6px solid #ff9800; }
        #question-area, #waiting-area { text-align: center; margin-top: 20px; }
        #question-item { font-size: 2em; font-weight: bold; margin-bottom: 20px; }
        .answer-buttons button { 
            font-size: 1.2em; 
            padding: 15px 30px;
            touch-action: manipulation; /* Prevents double-tap zoom on iOS */
        }
        .sid-text {
            color: #999;
            font-size: 0.8em;
            text-align: center;
            margin-top: 20px;
        }
        #reconnecting-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #ff9800;
            color: white;
            text-align: center;
            padding: 5px;
            font-weight: bold;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="reconnecting-indicator" class="hidden">Reconnecting to server...</div>
    <div class="container">
        <h1>Live Quiz</h1>

        <div id="connection-status" class="status-message status-info">Connecting to server...</div>

        <!-- Team Management Area -->
        <div id="team-management-area">
            <h2>Team Up!</h2>
            <div id="create-team-section">
                <h3>Create a New Team</h3>
                <input type="text" id="team-name-input" placeholder="Enter Team Name">
                <button id="create-team-btn">Create Team</button>
            </div>
            
            <div id="join-team-section">
                <h3>Join an Existing Team</h3>
                <ul id="available-teams-list"></ul>
                <p id="no-teams-message" class="hidden">No teams available to join currently. Create one or wait!</p>
            </div>
        </div>

        <!-- In Team Area -->
        <div id="in-team-area" class="hidden">
            <h2 id="current-team-name"></h2>
            <p id="team-status" class="status-message status-info">Waiting for partner...</p>
            <button id="leave-team-btn">Leave Team</button>
        </div>

        <!-- Question Area -->
        <div id="question-area" class="hidden">
            <h2>Question <span id="round-number"></span></h2>
            <p id="question-text">Your item is:</p>
            <div id="question-item"></div>
            <div class="answer-buttons">
                <button id="answer-true-btn">TRUE</button>
                <button id="answer-false-btn">FALSE</button>
            </div>
        </div>

        <!-- Waiting for Partner/Next Question Area -->
        <div id="waiting-area" class="hidden">
            <p id="waiting-message" class="status-message status-info">Answer submitted. Waiting for your partner...</p>
        </div>

        <div id="sid-display" class="sid-text"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // Session persistence and robustness improvements
        const SESSION_STORAGE_KEY = 'chsh_game_session';
        const reconnectingIndicator = document.getElementById("reconnecting-indicator");
        let reconnectionAttempts = 0;
        let maxReconnectionAttempts = 5;
        let reconnectionDelay = 1000; // Start with 1 second
        
        // Participant App Logic
        const socket = io(window.location.origin, {
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000
        });

        const connectionStatusDiv = document.getElementById("connection-status");
        const teamManagementArea = document.getElementById("team-management-area");
        const createTeamSection = document.getElementById("create-team-section");
        const teamNameInput = document.getElementById("team-name-input");
        const createTeamBtn = document.getElementById("create-team-btn");
        const joinTeamSection = document.getElementById("join-team-section");
        const availableTeamsList = document.getElementById("available-teams-list");
        const noTeamsMessage = document.getElementById("no-teams-message");
        
        const inTeamArea = document.getElementById("in-team-area");
        const currentTeamNameHeader = document.getElementById("current-team-name");
        const teamStatusDiv = document.getElementById("team-status");
        const leaveTeamBtn = document.getElementById("leave-team-btn");

        const questionArea = document.getElementById("question-area");
        const roundNumberSpan = document.getElementById("round-number");
        const questionItemDiv = document.getElementById("question-item");
        const answerTrueBtn = document.getElementById("answer-true-btn");
        const answerFalseBtn = document.getElementById("answer-false-btn");

        const waitingArea = document.getElementById("waiting-area");
        const waitingMessage = document.getElementById("waiting-message");

        let currentTeam = null;
        let isProcessingTeamAction = false; // Flag to prevent duplicate team actions
        let currentRoundId = null;
        let currentAssignedItem = null;
        let sessionData = null;
        let isReconnecting = false;

        // Session persistence functions
        function saveSessionData() {
            if (!currentTeam) return;
            
            const data = {
                socketId: socket.id,
                teamName: currentTeam,
                isCreator: teamStatusDiv.innerHTML.includes("Team created") || 
                           (sessionData && sessionData.isCreator),
                roundId: currentRoundId,
                assignedItem: currentAssignedItem,
                timestamp: new Date().getTime()
            };
            
            try {
                localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(data));
                console.log("Session data saved:", data);
            } catch (e) {
                console.error("Failed to save session data:", e);
            }
        }

        function loadSessionData() {
            try {
                const data = localStorage.getItem(SESSION_STORAGE_KEY);
                if (data) {
                    sessionData = JSON.parse(data);
                    console.log("Session data loaded:", sessionData);
                    
                    // Check if session data is too old (e.g., more than 1 hour)
                    const now = new Date().getTime();
                    const sessionAge = now - sessionData.timestamp;
                    if (sessionAge > 3600000) { // 1 hour in milliseconds
                        console.log("Session data is too old, clearing");
                        clearSessionData();
                        return null;
                    }
                    
                    return sessionData;
                }
            } catch (e) {
                console.error("Failed to load session data:", e);
                clearSessionData();
            }
            return null;
        }

        function clearSessionData() {
            try {
                localStorage.removeItem(SESSION_STORAGE_KEY);
                sessionData = null;
                console.log("Session data cleared");
            } catch (e) {
                console.error("Failed to clear session data:", e);
            }
        }

        function attemptReconnection() {
            if (!sessionData || isReconnecting) return;
            
            isReconnecting = true;
            showStatus("Attempting to reconnect to your previous session...", "warning");
            reconnectingIndicator.classList.remove("hidden");
            
            console.log("Attempting to reconnect to team:", sessionData.teamName);
            
            // Wait for socket to be connected before attempting to rejoin
            if (socket.connected) {
                performReconnection();
            } else {
                socket.once('connect', performReconnection);
            }
        }

        function performReconnection() {
            if (!sessionData) {
                isReconnecting = false;
                reconnectingIndicator.classList.add("hidden");
                return;
            }
            
            if (sessionData.isCreator) {
                // If user was a team creator, we need special handling
                // since we can't directly recreate the team (it might still exist)
                socket.emit('verify_team_membership', { 
                    team_name: sessionData.teamName,
                    previous_sid: sessionData.socketId
                });
            } else {
                // If user was a team member, attempt to rejoin
                socket.emit('rejoin_team', { 
                    team_name: sessionData.teamName,
                    previous_sid: sessionData.socketId
                });
            }
            
            // Set a timeout to clear reconnection state if no response
            setTimeout(() => {
                if (isReconnecting) {
                    isReconnecting = false;
                    reconnectingIndicator.classList.add("hidden");
                    showStatus("Reconnection attempt timed out. Please join or create a team manually.", "error");
                }
            }, 5000);
        }

        function showStatus(message, type = "info") {
            connectionStatusDiv.textContent = message;
            connectionStatusDiv.className = `status-message status-${type}`;
        }

        function updateTeamListView(teams) {
            try {
                availableTeamsList.innerHTML = "";
                if (teams && teams.length > 0 && !currentTeam) {
                    noTeamsMessage.classList.add("hidden");
                    teams.forEach(team => {
                        const li = document.createElement("li");
                        li.textContent = team.team_name;
                        const joinBtn = document.createElement("button");
                        joinBtn.textContent = "Join";
                        joinBtn.onclick = () => {
                            if (!isProcessingTeamAction) {
                                isProcessingTeamAction = true;
                                joinBtn.disabled = true;
                                socket.emit("join_team", { team_name: team.team_name });
                            }
                        };
                        li.appendChild(joinBtn);
                        availableTeamsList.appendChild(li);
                    });
                } else {
                    noTeamsMessage.classList.remove("hidden");
                }
            } catch (e) {
                console.error("Error updating team list:", e);
            }
        }

        function showTeamManagement() {
            teamManagementArea.classList.remove("hidden");
            inTeamArea.classList.add("hidden");
            questionArea.classList.add("hidden");
            waitingArea.classList.add("hidden");
            currentTeam = null;
            currentRoundId = null;
            currentAssignedItem = null;
            clearSessionData();
        }

        function showInTeamView(teamName, statusMessage) {
            teamManagementArea.classList.add("hidden");
            inTeamArea.classList.remove("hidden");
            questionArea.classList.add("hidden");
            waitingArea.classList.add("hidden");
            currentTeamNameHeader.textContent = `Team: ${teamName}`;
            teamStatusDiv.textContent = statusMessage;
            teamStatusDiv.className = "status-message status-info";
            currentTeam = teamName;
            saveSessionData();
        }
        
        function showQuestionView(roundId, roundNum, item) {
            teamManagementArea.classList.add("hidden");
            inTeamArea.classList.add("hidden");
            questionArea.classList.remove("hidden");
            waitingArea.classList.add("hidden");
            document.getElementById("question-text").textContent = "Your item is:";
            roundNumberSpan.textContent = roundNum;
            questionItemDiv.textContent = item;
            answerTrueBtn.disabled = true;
            answerFalseBtn.disabled = true;
            currentRoundId = roundId;
            currentAssignedItem = item;
            
            // Add delay before enabling buttons
            setTimeout(() => {
                answerTrueBtn.disabled = false;
                answerFalseBtn.disabled = false;
            }, 100); // 0.1ms delay
            
            saveSessionData();
        }

        function showWaitingView(message) {
            // Don't hide question area, just disable buttons and update text
            const questionText = document.querySelector("#question-area p");
            questionText.textContent = "Waiting for partner response";
            answerTrueBtn.disabled = true;
            answerFalseBtn.disabled = true;
            waitingArea.classList.remove("hidden");
            waitingMessage.textContent = message;
            waitingMessage.className = "status-message status-info";
        }

        // SocketIO Event Handlers
        socket.on("connect", () => {
            showStatus("Connected to server!", "success");
            reconnectingIndicator.classList.add("hidden");
            reconnectionAttempts = 0;
            document.getElementById("sid-display").textContent = `Session ID: ${socket.id}`;
            
            // Check for existing session
            const existingSession = loadSessionData();
            if (existingSession && !currentTeam) {
                attemptReconnection();
            } else if (!currentTeam) {
                showTeamManagement(); // Show team management on fresh connect
            }
        });

        socket.on("disconnect", () => {
            showStatus("Disconnected from server. Attempting to reconnect...", "error");
            reconnectingIndicator.classList.remove("hidden");
        });

        socket.on("reconnect_attempt", (attemptNumber) => {
            reconnectionAttempts = attemptNumber;
            showStatus(`Reconnection attempt ${attemptNumber}...`, "warning");
            reconnectingIndicator.classList.remove("hidden");
            reconnectingIndicator.textContent = `Reconnecting to server (attempt ${attemptNumber})...`;
        });

        socket.on("reconnect", () => {
            showStatus("Reconnected to server!", "success");
            reconnectingIndicator.classList.add("hidden");
            
            // If we were in a team before, attempt to rejoin
            if (sessionData && sessionData.teamName) {
                attemptReconnection();
            }
        });

        socket.on("reconnect_error", (error) => {
            console.error("Reconnection error:", error);
            showStatus(`Reconnection error: ${error.message || "Unknown error"}`, "error");
        });

        socket.on("reconnect_failed", () => {
            showStatus("Failed to reconnect after multiple attempts. Please refresh the page.", "error");
            reconnectingIndicator.classList.add("hidden");
        });

        socket.on("error", (data) => {
            isProcessingTeamAction = false;
            createTeamBtn.disabled = false;
            showStatus(`Error: ${data.message}`, "error");
            
            // If reconnecting, stop and show team management
            if (isReconnecting) {
                isReconnecting = false;
                reconnectingIndicator.classList.add("hidden");
                showTeamManagement();
            }
        });

        socket.on("available_teams", (teams) => {
            updateTeamListView(teams);
        });

        socket.on("teams_updated", (teams) => {
            updateTeamListView(teams);
        });

        socket.on("team_created", (data) => {
            currentTeam = data.team_name;
            isProcessingTeamAction = false;
            createTeamBtn.disabled = false;
            showInTeamView(data.team_name, "Team created! Waiting for a partner.");
            showStatus(`Team '${data.team_name}' created. Waiting for partner.`, "success");
            
            // Update session data with creator status
            if (sessionData) {
                sessionData.isCreator = true;
                saveSessionData();
            }
            
            // End reconnection process if active
            if (isReconnecting) {
                isReconnecting = false;
                reconnectingIndicator.classList.add("hidden");
            }
        });

        socket.on("team_joined", (data) => {
            currentTeam = data.team_name;
            showInTeamView(data.team_name, "You have joined the team! Waiting for game to start or partner if they were first.");
            teamStatusDiv.innerHTML = "You have joined the team! Waiting for game to start or partner if they were first.";
            showStatus(`Successfully joined team '${data.team_name}'.`, "success");
            
            // Update session data
            if (sessionData) {
                sessionData.isCreator = false;
                saveSessionData();
            }
            
            // End reconnection process if active
            if (isReconnecting) {
                isReconnecting = false;
                reconnectingIndicator.classList.add("hidden");
            }
        });

        socket.on("rejoin_team_success", (data) => {
            currentTeam = data.team_name;
            showInTeamView(data.team_name, data.status_message || "Successfully rejoined team!");
            showStatus(`Successfully rejoined team '${data.team_name}'.`, "success");
            
            // If there's an active round, show it
            if (data.current_round) {
                showQuestionView(
                    data.current_round.round_id, 
                    data.current_round.round_number, 
                    data.current_round.item
                );
                
                // If already answered, show waiting view
                if (data.already_answered) {
                    showWaitingView("You've already answered this round. Waiting for partner and next question...");
                }
            }
            
            // End reconnection process
            isReconnecting = false;
            reconnectingIndicator.classList.add("hidden");
        });

        socket.on("rejoin_team_failed", (data) => {
            showStatus(`Failed to rejoin team: ${data.message}`, "error");
            showTeamManagement();
            clearSessionData();
            
            // End reconnection process
            isReconnecting = false;
            reconnectingIndicator.classList.add("hidden");
        });

        socket.on("partner_joined", (data) => {
            if (currentTeam === data.team_name) {
                const currentStatus = teamStatusDiv.innerHTML;
                const matches = currentStatus.match(/Round \d+: Answer submitted successfully/g);
                const submissionHistory = matches ? "<br><br>" + matches.join("<br>") : "";
                teamStatusDiv.innerHTML = "Partner has joined! Quiz will start soon." + submissionHistory;
                teamStatusDiv.className = "status-message status-success";
                showStatus(`Partner joined team '${data.team_name}'.`, "info");
                saveSessionData();
            }
        });
        
        socket.on("team_status_update", (data) => {
            if (currentTeam === data.team_name) {
                const currentStatus = teamStatusDiv.innerHTML;
                const matches = currentStatus.match(/Round \d+: Answer submitted successfully/g);
                const submissionHistory = matches ? "<br><br>" + matches.join("<br>") : "";
                
                if (data.status === "full") {
                     teamStatusDiv.innerHTML = "Team is full! Waiting for presenter to start the game..." + submissionHistory;
                     teamStatusDiv.className = "status-message status-info";
                } else if (data.status === "waiting_for_partner") {
                     teamStatusDiv.innerHTML = "Partner left. Waiting for a new partner." + submissionHistory;
                     teamStatusDiv.className = "status-message status-info";
                } else if (data.status === "partner_left") {
                    teamStatusDiv.innerHTML = "Your partner has left. Waiting for a new one or the team might disband." + submissionHistory;
                    teamStatusDiv.className = "status-message status-info";
                    // If quiz was active, might need to go to a waiting state for questions
                    questionArea.classList.add("hidden");
                    waitingArea.classList.add("hidden");
                }
                saveSessionData();
            }
        });

        socket.on("partner_left", (data) => {
            if (currentTeam) { // Check if the user is in a team
                const currentStatus = teamStatusDiv.innerHTML;
                const matches = currentStatus.match(/Round \d+: Answer submitted successfully/g);
                const submissionHistory = matches ? "<br><br>" + matches.join("<br>") : "";
                
                teamStatusDiv.innerHTML = data.message + " Waiting for a new partner." + submissionHistory;
                teamStatusDiv.className = "status-message status-info";
                questionArea.classList.add("hidden"); // Stop questions if partner leaves
                waitingArea.classList.add("hidden");
                showStatus(data.message, "info");
                saveSessionData();
                // The backend should also send a teams_updated so the join list becomes accurate
            }
        });

        socket.on("team_disbanded", (data) => {
            showStatus(data.message, "info");
            showTeamManagement();
            clearSessionData();
        });
        
        socket.on("left_team_success", (data) => {
            showStatus(data.message, "success");
            showTeamManagement();
            clearSessionData();
        });

        socket.on("new_question", (data) => {
            showQuestionView(data.round_id, data.round_number, data.item);
        });

        socket.on("answer_confirmed", (data) => {
            showWaitingView("Answer confirmed. Waiting for partner and next question...");
            // Update team status with submission info
            const currentStatus = teamStatusDiv.textContent;
            const roundNum = roundNumberSpan.textContent;
            teamStatusDiv.innerHTML = `${currentStatus}<br><br>Round ${roundNum}: Answer submitted successfully`;
            saveSessionData();
        });
        
        socket.on("game_start", () => {
            if (currentTeam) {
                teamStatusDiv.innerHTML = "Game has started! Get ready for questions...";
                teamStatusDiv.className = "status-message status-success";
                saveSessionData();
            }
        });

        socket.on("round_complete", (data) => {
            if (currentTeam === data.team_name) {
                // The new_question event will follow if the game continues
                // For now, just acknowledge. Can add more specific UI later.
                console.log(`Round ${data.round_number} complete for team ${data.team_name}`);
                // The waiting view is likely already shown from answer_confirmed
            }
        });

        // Event Listeners for UI elements
        createTeamBtn.addEventListener("click", async () => {
            if (isProcessingTeamAction) return; // Prevent duplicate actions
            const teamName = teamNameInput.value.trim();
            if (teamName) {
                isProcessingTeamAction = true;
                createTeamBtn.disabled = true;
                socket.emit("create_team", { team_name: teamName });
                teamNameInput.value = ""; // Clear input after submission
            } else {
                showStatus("Please enter a team name", "error");
            }
        });

        leaveTeamBtn.addEventListener("click", () => {
            if (confirm("Are you sure you want to leave this team?")) {
                socket.emit("leave_team", {});
            }
        });

        answerTrueBtn.addEventListener("click", () => {
            if (currentRoundId && currentAssignedItem) {
                answerTrueBtn.disabled = true;
                answerFalseBtn.disabled = true;
                socket.emit("submit_answer", {
                    round_id: currentRoundId,
                    item: currentAssignedItem,
                    answer: true
                });
            }
        });

        answerFalseBtn.addEventListener("click", () => {
            if (currentRoundId && currentAssignedItem) {
                answerTrueBtn.disabled = true;
                answerFalseBtn.disabled = true;
                socket.emit("submit_answer", {
                    round_id: currentRoundId,
                    item: currentAssignedItem,
                    answer: false
                });
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log("Page is now visible, checking connection status");
                if (!socket.connected && currentTeam) {
                    showStatus("Reconnecting after page was hidden...", "warning");
                    socket.connect();
                }
            }
        });

        // Handle beforeunload to warn about leaving during active game
        window.addEventListener('beforeunload', (e) => {
            if (currentTeam && questionArea.classList.contains('hidden') === false) {
                // User is in active question, show warning
                const message = "You're in the middle of a question. Are you sure you want to leave?";
                e.returnValue = message;
                return message;
            }
        });

        // Initialize - check for existing session on page load
        window.addEventListener('load', () => {
            const existingSession = loadSessionData();
            if (existingSession) {
                showStatus("Found previous session. Attempting to reconnect...", "info");
                // Actual reconnection will happen after socket connects
            }
        });
    </script>
</body>
</html>
